{% extends 'nav_bar.html' %}
{% load static %}

{% block content %}
<div class="room-detail-container">

    <div class="room-header">
        <h1 class="room-title">{{ room.name }}</h1>
        <button class="btn btn-friends" onclick="toggleFriendsSection()">
            <span class="emoji">üë•</span>
            Friends
        </button>
    </div>


    <div class="friends-section" id="friends-section" style="display: none;">
        <div class="friends-container">
            {% if request.user == room.host %}
            <div class="invite-section">
                <h3>Invite Friends</h3>
                <form method="post" class="invite-form">
                    {% csrf_token %}
                    <input type="hidden" id="room-pk" value="{{ room.pk }}">
                    <div class="search-container">
                        <input type='text' name='search_name' id='search_name' placeholder='Search friend...' class="search-input">
                        <button type="submit" class="btn btn-invite">Add friend</button>
                    </div>
                    <div id="search-results" class="search-results"></div>
                </form>
            </div>
            {% endif %}

            {% if request.user == room.host and join_requests %}
            <div class="join-requests-section">
                <h3>Join Requests</h3>
                <div class="requests-list">
                    {% for join_request in join_requests %}
                    <div class="request-item">
                        <span class="username">{{ join_request.user.username }}</span>
                        <form method="post" class="request-form">
                            {% csrf_token %}
                            <input type="hidden" name="join_request_id" value="{{ join_request.id }}">
                            <div class="request-actions">
                                <button type="submit" name="action" value="accept" class="btn btn-accept">Accept</button>
                                <button type="submit" name="action" value="reject" class="btn btn-reject">Reject</button>
                            </div>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}


            <div class="members-section">
                <h3>Room Members ({{ room_members_count }})</h3>
                <div class="members-list">
                    <div class="member-item host">
                        <span class="member-name">{{ room.host.username }}</span>
                        <span class="member-role">Host</span>
                    </div>
                    {% for member in room.members.all %}
                        {% if member != room.host %}
                        <div class="member-item">
                            <span class="member-name">{{ member.username }}</span>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="top-movies-section">
        <h2 class="section-title">üìΩÔ∏è Top Rated Movies in Room</h2>
        <p class="section-subtitle">Based on ratings from {{ room_members_count }} members</p>

        {% if movies_with_details %}
            <div class="movies-grid">
                {% for movie_data in movies_with_details %}
                <div class="movie-card">
                    <div class="movie-content">
                        <div class="movie-poster">
                            {% if movie_data.movie.poster_url %}
                                <img src="{{ movie_data.movie.poster_url }}"
                                     alt="{{ movie_data.movie.title }}"
                                     class="poster-image">
                            {% else %}
                                <div class="poster-placeholder">
                                    <span>üé¨</span>
                                    <p>No poster</p>
                                </div>
                            {% endif %}
                        </div>
                        <div class="movie-info">
                            <h4 class="movie-name">{{ movie_data.movie.title }}</h4>
                            <p class="movie-desc">{{ movie_data.movie.description|truncatechars:120 }}</p>
                        
                            <div class="rating-info">
                                <div class="average-rating">
                                    <span class="rating-label">Room Average:</span>
                                    <span class="rating-score">{{ movie_data.room_avg_rating|floatformat:1 }}/3.0</span>
                                </div>
                                <div class="rating-count">
                                    Rated by {{ movie_data.room_ratings_count }} members
                                </div>
                            </div>
                        
                            <div class="rating-breakdown">
                                <span class="breakdown-label">Rating Details:</span>
                                <div class="breakdown-tags">
                                    {% if movie_data.rating_breakdown.love > 0 %}
                                        <span class="rating-tag love">‚ù§Ô∏è {{ movie_data.rating_breakdown.love }}</span>
                                    {% endif %}
                                    {% if movie_data.rating_breakdown.like > 0 %}
                                        <span class="rating-tag like">üëç {{ movie_data.rating_breakdown.like }}</span>
                                    {% endif %}
                                    {% if movie_data.rating_breakdown.watched > 0 %}
                                        <span class="rating-tag watched">üëÅÔ∏è {{ movie_data.rating_breakdown.watched }}</span>
                                    {% endif %}
                                    {% if movie_data.rating_breakdown.dislike > 0 %}
                                        <span class="rating-tag dislike">üëé {{ movie_data.rating_breakdown.dislike }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="movie-footer">
                        {% if movie_data.movie.trailer_url %}
                            <a href="{{ movie_data.movie.trailer_url }}"
                                target="_blank"
                                class="trailer-link">
                                 üé¨ Watch Trailer
                            </a>
                        {% endif %}
    
                        {% if request.user == room.host %}
                             <form method="post" style="display: inline;">
                                {% csrf_token %}
                               <input type="hidden" name="mark_watched_movie_id" value="{{ movie_data.movie.id }}">
                                 <button type="submit" class="movie-footer-watched-btn">
                                    üëÅWatched
                                </button>
                             </form>
                        {% endif %}
    
                        <span class="global-rating">
                             Global: {{ movie_data.movie.average_rating|floatformat:1 }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-movies">
                <h3>No Rated Movies</h3>
                <p>Room members haven't rated any movies yet.</p>
            </div>
        {% endif %}
    </div>
</div>

<script src="{% static 'js/search.js' %}"></script>
<script>
function toggleFriendsSection() {
    const friendsSection = document.getElementById('friends-section');
    const isVisible = friendsSection.style.display !== 'none';

    if (isVisible) {
        friendsSection.style.display = 'none';
    } else {
        friendsSection.style.display = 'block';
    }
}
</script>
{% endblock %}